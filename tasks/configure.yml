---
- name: generate database dsn
  include_vars: "{{ mattermost_database_type }}.yml"

- name: create configuration directory
  become: yes
  file:
    state=directory
    path={{ mattermost_config_dir }}
    owner={{ mattermost_user }}
    group={{ mattermost_group }}

- name: configure mattermost
  template:
    src=etc_mattermost_config-{{ mattermost_version }}.json.j2
    dest={{ mattermost_config_dir }}/config.json
    owner={{ mattermost_user }}
    group={{ mattermost_group }}
  when: mattermost_use_autogenerated_config

- name: symlink configuration file
  file:
    state=link
    src={{ mattermost_config_dir }}/config.json
    dest={{ mattermost_install_dir }}/config/config.json
    owner={{ mattermost_user }}
    group={{ mattermost_group }}
    force=yes

- name: create mattermost pidfile location
  file:
    state=directory
    path=/var/run/mattermost
    owner={{ mattermost_user }}
    group={{ mattermost_group }}

- name: configure mattermost upstart script
  template:
    src=etc_init_mattermost.conf.j2
    dest=/etc/init/mattermost.conf
    owner=root
    group=root
  when: mattermost_automatic_start

- name: make sure mattermost service is running and enabled at boot
  service: name=mattermost state=running enabled=yes
  when: mattermost_automatic_start
